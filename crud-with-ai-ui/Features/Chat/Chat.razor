@page "/"
@page "/chat"

@inject ChatPageService PageService
@inject NavigationManager Navigation

<PageTitle>Chat</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Chat</h1>
    @if (PageService.IsShowingSpinner)
    {
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    }
</div>

@if (PageService.Error is not null)
{
    <div class="alert alert-danger" role="alert">
        @PageService.Error.GetDisplayMessage()
    </div>
}

<div class="card shadow-sm">
    <div class="card-body d-flex flex-column gap-3">
        <ChatMessages Messages="PageService.Messages" IsLoading="PageService.IsLoading" />
        <ChatInput OnSend="HandleSendAsync" OnClear="HandleClearAsync" IsLoading="PageService.IsLoading" />
    </div>
</div>

@code {

    protected override void OnInitialized()
    {
        var relativePath = Navigation.ToBaseRelativePath(Navigation.Uri);
        if (string.IsNullOrEmpty(relativePath))
        {
            Navigation.NavigateTo("/chat", replace: true);
        }

        PageService.Initialize();
    }

    private Task HandleSendAsync(string message)
        => PageService.SendMessageAsync(message);

    private Task HandleClearAsync()
        => PageService.ClearConversation();
}
